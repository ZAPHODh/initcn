---
title: Subscription
description: Set up Stripe subscription management with Prisma ORM
---

omplete guide for integrating Stripe subscription management using Prisma ORM.

## Installation from registry

```bash
pnpm shadcn@latest add @initcn/payment-stripe-prisma
```

This will install the following files:

| File | Description |
|------|-------------|
| `lib/server/payment/db.ts` | Stripe client initialization |
| `lib/server/payment/subscription.ts` | Subscription status queries |
| `lib/server/payment/webhooks.ts` | Webhook event processing |
| `app/api/stripe/route.ts` | Checkout & billing portal endpoint |
| `app/api/webhooks/stripe/route.ts` | Webhook handler |
| `app/actions/create-checkout.ts` | Server action for checkout |
| `app/actions/manage-billing.ts` | Server action for billing portal |

## Database Schema

Add these models to your `prisma/schema.prisma`:

```prisma
// Add to your existing User model
model User {
  id                     String    @id @unique @default(cuid())
  email                  String?   @unique
  // ... your existing fields ...

  // Stripe subscription fields
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  stripePriceId          String?   @map("stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map("stripe_current_period_end")
  planType               PlanType  @default(FREE)
}

// Webhook event tracking for idempotency
model StripeWebhookEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  processed     Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([processed])
  @@index([stripeEventId])
}

enum PlanType {
  FREE
  SIMPLE
  PRO
}
```

Run the migration:

```bash
npx prisma migrate dev --name add_stripe_subscription
```

## Environment Variables

Add these to your `.env.local`:

```bash
# Stripe API Keys
STRIPE_SECRET_KEY="sk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_..."
NEXT_PUBLIC_APP_URL="http://localhost:3000"

# Simple Plan Price IDs
STRIPE_SIMPLE_BRL_MONTHLY_ID="price_..."
STRIPE_SIMPLE_BRL_YEARLY_ID="price_..."
STRIPE_SIMPLE_USD_MONTHLY_ID="price_..."
STRIPE_SIMPLE_USD_YEARLY_ID="price_..."
STRIPE_SIMPLE_EUR_MONTHLY_ID="price_..."
STRIPE_SIMPLE_EUR_YEARLY_ID="price_..."

# Pro Plan Price IDs
STRIPE_PRO_BRL_MONTHLY_ID="price_..."
STRIPE_PRO_BRL_YEARLY_ID="price_..."
STRIPE_PRO_USD_MONTHLY_ID="price_..."
STRIPE_PRO_USD_YEARLY_ID="price_..."
STRIPE_PRO_EUR_MONTHLY_ID="price_..."
STRIPE_PRO_EUR_YEARLY_ID="price_..."
```

## Stripe Dashboard Setup

### 1. Create Products

In [Stripe Dashboard > Products](https://dashboard.stripe.com/products):

1. Create "Simple" product with description
2. Create "Pro" product with description

### 2. Create Prices

For each product, create prices:

- Monthly BRL, USD, EUR
- Yearly BRL, USD, EUR (with discount)

### 3. Configure Webhook

Add webhook endpoint in [Stripe Dashboard > Webhooks](https://dashboard.stripe.com/webhooks):

**Endpoint URL:** `https://yourdomain.com/api/webhooks/stripe`

**Events to send:**
- `checkout.session.completed`
- `checkout.session.async_payment_succeeded`
- `invoice.payment_succeeded`
- `customer.subscription.updated`
- `customer.subscription.deleted`

## Usage

### Check Subscription Status

```tsx
import { getUserSubscriptionPlan } from "@/lib/server/payment/subscription";
import { getCurrentSession } from "@/lib/server/auth/session";

export default async function DashboardPage() {
  const { user } = await getCurrentSession();
  const plan = await getUserSubscriptionPlan(user.id);

  return (
    <div>
      <p>Current Plan: {plan.name}</p>
      <p>Status: {plan.isActive ? "Active" : "Inactive"}</p>
      {plan.isPro && <p>Pro features unlocked!</p>}
    </div>
  );
}
```

### Create Checkout Session (API Route)

Redirect users to the checkout page:

```tsx
"use client";

export function UpgradeButton() {
  const handleUpgrade = async () => {
    const response = await fetch("/api/stripe?plan=pro&interval=monthly");
    const { url } = await response.json();
    window.location.href = url;
  };

  return <button onClick={handleUpgrade}>Upgrade to Pro</button>;
}
```

### Create Checkout Session (Server Action)

```tsx
"use client";

import { createCheckout } from "@/app/actions/create-checkout";
import { useAction } from "next-safe-action/hooks";

export function UpgradeButton() {
  const { execute, status } = useAction(createCheckout);

  const handleUpgrade = async () => {
    const result = await execute({
      plan: "pro",
      interval: "monthly",
      locale: "en",
    });

    if (result?.data?.url) {
      window.location.href = result.data.url;
    }
  };

  return (
    <button onClick={handleUpgrade} disabled={status === "executing"}>
      {status === "executing" ? "Loading..." : "Upgrade to Pro"}
    </button>
  );
}
```

### Manage Billing Portal

```tsx
"use client";

import { manageBilling } from "@/app/actions/manage-billing";
import { useAction } from "next-safe-action/hooks";

export function ManageBillingButton() {
  const { execute, status } = useAction(manageBilling);

  const handleManage = async () => {
    const result = await execute({});

    if (result?.data?.url) {
      window.location.href = result.data.url;
    }
  };

  return (
    <button onClick={handleManage} disabled={status === "executing"}>
      Manage Billing
    </button>
  );
}
```

### Check Plan Limits

```tsx
import { getPlanLimits } from "@/lib/server/payment/subscription";
import { getUserSubscriptionPlan } from "@/lib/server/payment/subscription";

export async function canCreateProject(userId: string): Promise<boolean> {
  const plan = await getUserSubscriptionPlan(userId);
  const limits = getPlanLimits(plan.name);

  // Check if user has reached project limit
  const projectCount = await getProjectCount(userId);

  if (limits.maxProjects === -1) return true; // Unlimited
  return projectCount < limits.maxProjects;
}
```

## Webhook Testing

### Local Development

Install Stripe CLI and forward webhooks:

```bash
# Install Stripe CLI
brew install stripe/stripe-cli/stripe

# Login to Stripe
stripe login

# Forward webhooks to local server
stripe listen --forward-to localhost:3000/api/webhooks/stripe
```

Copy the webhook signing secret to your `.env.local`:
```bash
STRIPE_WEBHOOK_SECRET="whsec_..."
```

### Test Events

Trigger test events:

```bash
# Test checkout completion
stripe trigger checkout.session.completed

# Test subscription update
stripe trigger customer.subscription.updated

# Test subscription cancellation
stripe trigger customer.subscription.deleted
```

## API Reference

### getUserSubscriptionPlan(userId)

Returns the user's current subscription plan with status.

```ts
const plan = await getUserSubscriptionPlan(userId);
// Returns: UserSubscriptionPlan
```

**Return type:**
```ts
interface UserSubscriptionPlan {
  name: string;
  description: string;
  stripePriceId: string;
  stripeCustomerId: string | null;
  stripeSubscriptionId: string | null;
  stripeCurrentPeriodEnd: number | null;
  isPro: boolean;
  isActive: boolean;
}
```

### getPlanLimits(planName)

Returns the feature limits for a plan.

```ts
const limits = getPlanLimits("PRO");
// Returns: PlanLimits
```

**Return type:**
```ts
interface PlanLimits {
  maxProjects: number;      // -1 = unlimited
  maxTeamMembers: number;
  maxStorageGB: number;
  maxAPICallsPerMonth: number;
  hasExports: boolean;
  hasAdvancedAnalytics: boolean;
  hasPrioritySupport: boolean;
  hasCustomBranding: boolean;
  hasAPIAccess: boolean;
  hasWebhooks: boolean;
}
```

### createCheckout

Server action to create a Stripe checkout session.

```ts
const result = await createCheckout({
  plan: "pro",           // "simple" | "pro"
  interval: "monthly",   // "monthly" | "yearly"
  locale: "en",          // Optional, defaults to "en"
});
// Returns: { url: string | null }
```

### manageBilling

Server action to redirect to Stripe billing portal.

```ts
const result = await manageBilling({});
// Returns: { url: string | null }
```
