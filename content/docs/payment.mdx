---
title: Subscriptions
description: Set up Stripe subscription management with Prisma ORM
---

## Installation

<InstallCommand feature="payments" />

---

## What is Installed

### API Routes

| File | Path | Description |
|------|------|-------------|
| `route.ts` | `app/api/stripe/route.ts` | Checkout session creation |
| `route.ts` | `app/api/webhooks/stripe/route.ts` | Stripe webhook handler |

### Server Actions

| File | Path | Description |
|------|------|-------------|
| `create-checkout.ts` | `app/actions/create-checkout.ts` | Create checkout session |
| `manage-billing.ts` | `app/actions/manage-billing.ts` | Open billing portal |

### Server Utilities

| File | Path | Description |
|------|------|-------------|
| `subscription.ts` | `lib/server/payment/subscription.ts` | Subscription status queries |
| `webhooks.ts` | `lib/server/payment/webhooks.ts` | Webhook event handlers |
| `config.ts` | `lib/server/payment/config.ts` | Stripe configuration |
| `pricing.ts` | `lib/server/payment/pricing.ts` | Multi-currency pricing |
| `validation.ts` | `lib/server/payment/validation.ts` | Input validation schemas |
| `db.ts` | `lib/server/payment/db.ts` | Stripe client instance |
| `types.ts` | `lib/server/payment/types.ts` | TypeScript types |

### Client Utilities

| File | Path | Description |
|------|------|-------------|
| `safe-action.ts` | `lib/client/safe-action.ts` | next-safe-action client |

### Other Files

| File | Path | Description |
|------|------|-------------|
| `prisma.schema` | `lib/server/payment/schemas/prisma.schema` | Prisma schema (copy manually) |
| `.env.example.subscription` | `.env.example.subscription` | Environment variables template |

---

## What's Next

<Steps>

### Add environment variables

Copy the installed `.env.example.subscription` to your `.env.local`:

```bash
cat .env.example.subscription >> .env.local
```

Then configure:

| Variable | Required | Description |
|----------|----------|-------------|
| `STRIPE_SECRET_KEY` | Yes | Stripe secret API key |
| `STRIPE_WEBHOOK_SECRET` | Yes | Webhook signing secret |
| `NEXT_PUBLIC_APP_URL` | Yes | Your app URL |
| `STRIPE_SIMPLE_*_ID` | Yes | Simple plan price IDs (6 total) |
| `STRIPE_PRO_*_ID` | Yes | Pro plan price IDs (6 total) |

### Add Prisma schema

Copy the schema from `lib/server/payment/schemas/prisma.schema` to your `prisma/schema.prisma`:

```prisma
// Add to your existing User model
model User {
  id                     String    @id @unique @default(cuid())
  email                  String?   @unique
  // ... your existing fields ...

  // Stripe subscription fields
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  stripePriceId          String?   @map("stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map("stripe_current_period_end")
  planType               PlanType  @default(FREE)
}

// Webhook event tracking for idempotency
model StripeWebhookEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  processed     Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([processed])
  @@index([stripeEventId])
}

enum PlanType {
  FREE
  SIMPLE
  PRO
}
```

Then run:

```bash
npx prisma migrate dev --name add_stripe_subscription
```

### Set up Stripe Dashboard

#### Create Products

In [Stripe Dashboard > Products](https://dashboard.stripe.com/products):

1. Create "Simple" product with description
2. Create "Pro" product with description

#### Create Prices

For each product, create prices for:

- Monthly BRL, USD, EUR
- Yearly BRL, USD, EUR (with discount)

#### Configure Webhook

Add webhook endpoint in [Stripe Dashboard > Webhooks](https://dashboard.stripe.com/webhooks):

**Endpoint URL:** `https://yourdomain.com/api/webhooks/stripe`

**Events to send:**
- `checkout.session.completed`
- `checkout.session.async_payment_succeeded`
- `invoice.payment_succeeded`
- `customer.subscription.updated`
- `customer.subscription.deleted`

### Test locally with Stripe CLI

```bash
# Install Stripe CLI
brew install stripe/stripe-cli/stripe

# Login and forward webhooks
stripe login
stripe listen --forward-to localhost:3000/api/webhooks/stripe
```

Copy the webhook signing secret to your `.env.local`.

</Steps>

---

## API Reference

### Server Actions

#### createCheckout

Creates a Stripe checkout session for subscription.

```ts
import { createCheckout } from "@/app/actions/create-checkout";
import { useAction } from "next-safe-action/hooks";

const { execute } = useAction(createCheckout);
const result = await execute({ plan: "pro", interval: "monthly", locale: "en" });
```

**Input:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `plan` | `"simple" \| "pro"` | Yes | Plan type |
| `interval` | `"monthly" \| "yearly"` | Yes | Billing interval |
| `locale` | `string` | No | Locale for currency (default: `"en"`) |

**Returns:**

| Field | Type | Description |
|-------|------|-------------|
| `url` | `string \| null` | Stripe checkout URL |

---

#### manageBilling

Redirects user to Stripe billing portal.

```ts
import { manageBilling } from "@/app/actions/manage-billing";
import { useAction } from "next-safe-action/hooks";

const { execute } = useAction(manageBilling);
const result = await execute({});
```

**Returns:**

| Field | Type | Description |
|-------|------|-------------|
| `url` | `string \| null` | Stripe billing portal URL |

---

### Subscription Management

#### getUserSubscriptionPlan

Returns the user's current subscription plan with status.

```ts
import { getUserSubscriptionPlan } from "@/lib/server/payment/subscription";

const plan = await getUserSubscriptionPlan(userId);
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `userId` | `string` | User ID |

**Returns:** `Promise<UserSubscriptionPlan>`

| Field | Type | Description |
|-------|------|-------------|
| `name` | `string` | Plan name (FREE, SIMPLE, PRO) |
| `description` | `string` | Plan description |
| `stripePriceId` | `string` | Current price ID |
| `stripeCustomerId` | `string \| null` | Stripe customer ID |
| `stripeSubscriptionId` | `string \| null` | Stripe subscription ID |
| `stripeCurrentPeriodEnd` | `number \| null` | Period end timestamp |
| `isPro` | `boolean` | Whether user has Pro plan |
| `isActive` | `boolean` | Whether subscription is active |

---

#### getPlanLimits

Returns the feature limits for a plan.

```ts
import { getPlanLimits } from "@/lib/server/payment/subscription";

const limits = getPlanLimits("PRO");
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `planName` | `string` | Plan name |

**Returns:** `PlanLimits`

| Field | Type | Description |
|-------|------|-------------|
| `maxProjects` | `number` | Max projects (-1 = unlimited) |
| `maxTeamMembers` | `number` | Max team members |
| `maxStorageGB` | `number` | Max storage in GB |
| `maxAPICallsPerMonth` | `number` | Max API calls |
| `hasExports` | `boolean` | Export feature |
| `hasAdvancedAnalytics` | `boolean` | Analytics feature |
| `hasPrioritySupport` | `boolean` | Priority support |
| `hasCustomBranding` | `boolean` | Custom branding |
| `hasAPIAccess` | `boolean` | API access |
| `hasWebhooks` | `boolean` | Webhooks feature |

---

### Pricing Utilities

#### getCurrencyFromLocale

Maps a locale code to the appropriate currency.

```ts
import { getCurrencyFromLocale } from "@/lib/server/payment/pricing";

const currency = getCurrencyFromLocale("pt"); // "BRL"
const currency = getCurrencyFromLocale("en"); // "USD"
const currency = getCurrencyFromLocale("fr"); // "EUR"
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `locale` | `string` | Locale code |

**Returns:** `Currency` (`"BRL" | "USD" | "EUR"`)

---

#### getPricingForLocale

Gets pricing information for all plans in the given locale.

```ts
import { getPricingForLocale } from "@/lib/server/payment/pricing";

const pricing = getPricingForLocale("en");
// { simple: PricingInfo, pro: PricingInfo }
```

**Returns:** `PlanPricing`

---

#### getPricingForPlan

Gets pricing information for a specific plan.

```ts
import { getPricingForPlan } from "@/lib/server/payment/pricing";

const pricing = getPricingForPlan("en", "pro");
// { currency: "USD", monthlyPrice: 15, yearlyPrice: 149.40, ... }
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `locale` | `string` | Locale code |
| `planType` | `"simple" \| "pro"` | Plan type |

**Returns:** `PricingInfo`

| Field | Type | Description |
|-------|------|-------------|
| `currency` | `Currency` | Currency code |
| `currencySymbol` | `string` | Currency symbol |
| `monthlyPrice` | `number` | Monthly price |
| `yearlyPrice` | `number` | Yearly price |
| `monthlyPriceFormatted` | `string` | Formatted monthly price |
| `yearlyPriceFormatted` | `string` | Formatted yearly price |

---

#### getStripePriceId

Retrieves the Stripe price ID from environment variables.

```ts
import { getStripePriceId } from "@/lib/server/payment/pricing";

const priceId = getStripePriceId("pro", "USD", "monthly");
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `planType` | `"simple" \| "pro"` | Plan type |
| `currency` | `Currency` | Currency code |
| `interval` | `"monthly" \| "yearly"` | Billing interval |

**Returns:** `string`

---

#### getPlanTypeFromPriceId

Resolves a plan type from a Stripe price ID.

```ts
import { getPlanTypeFromPriceId } from "@/lib/server/payment/pricing";

const planType = getPlanTypeFromPriceId("price_xxx"); // "PRO" | "SIMPLE" | "FREE"
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `priceId` | `string` | Stripe price ID |

**Returns:** `PlanType` (`"FREE" | "SIMPLE" | "PRO"`)

---

#### formatPrice

Formats a price amount with the appropriate currency symbol.

```ts
import { formatPrice } from "@/lib/server/payment/pricing";

const formatted = formatPrice(15, "USD"); // "$15"
```

**Parameters:**

| Name | Type | Description |
|------|------|-------------|
| `amount` | `number` | Price amount |
| `currency` | `Currency` | Currency code |

**Returns:** `string`

---

### Types

```ts
type Currency = "BRL" | "USD" | "EUR";
type Locale = "en" | "pt" | "es" | "fr" | "de" | "it";
type PlanType = "FREE" | "SIMPLE" | "PRO";
type BillingInterval = "monthly" | "yearly";

interface PricingInfo {
  currency: Currency;
  currencySymbol: string;
  monthlyPrice: number;
  yearlyPrice: number;
  monthlyPriceFormatted: string;
  yearlyPriceFormatted: string;
}

interface PlanPricing {
  simple: PricingInfo;
  pro: PricingInfo;
}

interface SubscriptionPlan {
  name: string;
  description: string;
  stripePriceId: string;
}

interface UserSubscriptionPlan extends SubscriptionPlan {
  stripeCustomerId: string | null;
  stripeSubscriptionId: string | null;
  stripePriceId: string;
  stripeCurrentPeriodEnd: number | null;
  isPro: boolean;
  isActive: boolean;
}

interface PlanLimits {
  maxProjects: number;
  maxTeamMembers: number;
  maxStorageGB: number;
  maxAPICallsPerMonth: number;
  hasExports: boolean;
  hasAdvancedAnalytics: boolean;
  hasPrioritySupport: boolean;
  hasCustomBranding: boolean;
  hasAPIAccess: boolean;
  hasWebhooks: boolean;
}

interface CreateCheckoutRequest {
  plan: "simple" | "pro";
  interval: BillingInterval;
  locale?: string;
}

interface CreateCheckoutResponse {
  url: string | null;
}

interface ManageBillingResponse {
  url: string | null;
}

interface StripeWebhookEvent {
  id: string;
  stripeEventId: string;
  type: string;
  processed: boolean;
  createdAt: Date;
}
```
