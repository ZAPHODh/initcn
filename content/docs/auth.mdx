---
title: OTP
description: Production-ready OTP authentication with Google OAuth
---

## Installation

<InstallCommand feature="auth" />

---

## What is Installed

| Category | Includes |
|----------|----------|
| Pages / Routes | Login page, modal interceptor (Next.js) |
| API Routes | send-otp, verify-otp, google, google-callback |
| Components | `auth-form`, `login-dialog` |
| Server utilities | session, otp, google, cookies, mail, rate-limit |
| DB schema | `prisma.schema` (User, Session, VerificationCode) |

---

## Setup

<Steps>

### Add environment variables

Copy `.env.example.otp` to your `.env.local`:

```bash
cat .env.example.otp >> .env.local
```

<FrameworkContent
  nextjs={<>
| Variable | Required | Description |
|----------|----------|-------------|
| `DATABASE_URL` | Yes | PostgreSQL connection string |
| `RESEND_API_KEY` | Production | Resend API key for emails |
| `AUTH_EMAIL_FROM` | Production | Sender email address |
| `UPSTASH_REDIS_REST_URL` | Production | Upstash Redis URL |
| `UPSTASH_REDIS_REST_TOKEN` | Production | Upstash Redis token |
| `GOOGLE_CLIENT_ID` | Optional | Google OAuth client ID |
| `GOOGLE_CLIENT_SECRET` | Optional | Google OAuth client secret |
| `GOOGLE_REDIRECT_URI` | Optional | `http://localhost:3000/api/auth/login/google/callback` |

<Callout type="info">
In development, emails are logged to console and rate limiting uses in-memory storage. Only `DATABASE_URL` is required to get started.
</Callout>
  </>}
  vite={<>
| Variable | Required | Description |
|----------|----------|-------------|
| `DATABASE_URL` | Yes | PostgreSQL connection string |
| `RESEND_API_KEY` | Production | Resend API key for emails |
| `AUTH_EMAIL_FROM` | Production | Sender email address |
| `UPSTASH_REDIS_REST_URL` | Production | Upstash Redis URL (optional, falls back to in-memory) |
| `UPSTASH_REDIS_REST_TOKEN` | Production | Upstash Redis token |
| `FRONTEND_URL` | Yes | Frontend origin, e.g. `http://localhost:5173` |
| `BACKEND_URL` | Yes | API server origin, e.g. `http://localhost:3001` |
| `GOOGLE_CLIENT_ID` | Optional | Google OAuth client ID |
| `GOOGLE_CLIENT_SECRET` | Optional | Google OAuth client secret |
| `GOOGLE_REDIRECT_URI` | Optional | `http://localhost:3000/api/auth/oauth/google/callback` |
  </>}
  tanstack={<>
| Variable | Required | Description |
|----------|----------|-------------|
| `DATABASE_URL` | Yes | PostgreSQL connection string |
| `RESEND_API_KEY` | Production | Resend API key for emails |
| `UPSTASH_REDIS_REST_URL` | Production | Upstash Redis URL (optional, falls back to in-memory) |
| `UPSTASH_REDIS_REST_TOKEN` | Production | Upstash Redis token |
| `FRONTEND_URL` | Yes | Frontend origin, e.g. `http://localhost:5173` |
| `BACKEND_URL` | Yes | API server origin, e.g. `http://localhost:3001` |
| `GOOGLE_CLIENT_ID` | Optional | Google OAuth client ID |
| `GOOGLE_CLIENT_SECRET` | Optional | Google OAuth client secret |
| `GOOGLE_REDIRECT_URI` | Optional | `http://localhost:3000/api/auth/oauth/google/callback` |
  </>}
/>

### Add Prisma schema

Copy `lib/server/auth/schemas/prisma.schema` to your `prisma/schema.prisma`:

```prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  picture       String?
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  verificationCodes VerificationCode[]
  sessions          Session[]
}

model VerificationCode {
  id        String   @id @default(cuid())
  userId    String
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
```

```bash
npx prisma generate
npx prisma db push
```

### Set up Google OAuth (optional)

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a project and enable the Google+ API
3. Create OAuth 2.0 credentials (Web application)
4. Add the redirect URI:

<FrameworkContent
  nextjs={<>`http://localhost:3000/api/auth/login/google/callback`</>}
  vite={<>`http://localhost:3000/api/auth/oauth/google/callback`</>}
  tanstack={<>`http://localhost:3000/api/auth/oauth/google/callback`</>}
/>

5. Copy Client ID and Secret to `.env.local`

### Test the installation

<FrameworkContent
  nextjs={<>Navigate to `/login` to verify everything works.</>}
  vite={<>Start your dev server and navigate to `/login`.</>}
  tanstack={<>Start your dev server and navigate to `/login`.</>}
/>

</Steps>

---

## API Reference

### Session

| Function | Description |
|----------|-------------|
| `getCurrentSession()` | Returns `{ user, session }` for the current request. Memoized via React `cache()`. |
| `validateSessionToken(token)` | Validates a token and auto-renews if expiring within 15 days. |
| `createSession(token, userId)` | Creates a new session in the database. |
| `invalidateSession(sessionId)` | Deletes a session by ID. |
| `invalidateAllUserSessions(userId)` | Deletes all sessions for a user ("logout everywhere"). |

```ts
import { getCurrentSession } from "@/lib/server/auth";

const { user, session } = await getCurrentSession();
if (!user) redirect("/login");
```

### OTP

| Function | Description |
|----------|-------------|
| `generateOTP(length?)` | Generates a random numeric OTP (default length: 6). |
| `getOTPExpiry(minutes?)` | Returns expiry Date (default: 3 minutes). |
| `isOTPExpired(expiresAt)` | Checks if an OTP has expired. |

### Types

```ts
interface User {
  id: string;
  email: string;
  name: string | null;
  picture: string | null;
  emailVerified: boolean;
  createdAt: Date;
  updatedAt: Date;
}

interface Session {
  id: string;
  userId: string;
  expiresAt: Date;
}

interface SessionValidationResult {
  session: Session | null;
  user: User | null;
}
```

### Constants

| Constant | Value | Description |
|----------|-------|-------------|
| `OTP_LENGTH` | `6` | Default OTP length |
| `OTP_EXPIRY_MINUTES` | `3` | Default OTP expiry |
| `SESSION_EXPIRY_DAYS` | `30` | Session duration |
| `SESSION_RENEWAL_THRESHOLD_DAYS` | `15` | Renew if less than this remaining |
| `SESSION_COOKIE_NAME` | `"session"` | Cookie name |
